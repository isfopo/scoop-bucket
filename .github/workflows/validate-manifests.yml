name: Validate Manifests

# Trigger on push and pull request to validate all manifests
on:
  push:
    branches: [ main, master ]
    paths: [ 'bucket/*.json' ]
  pull_request:
    branches: [ main, master ]
    paths: [ 'bucket/*.json' ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Validate all manifests
        run: |
          echo "Validating all manifest files..."
          
          # Find all JSON files in bucket directory
          MANIFESTS=$(find bucket -name "*.json" -type f)
          
          if [ -z "$MANIFESTS" ]; then
            echo "No manifest files found in bucket directory"
            exit 0
          fi
          
          # Validate each manifest
          VALIDATION_FAILED=0
          for manifest in $MANIFESTS; do
            echo "Validating $manifest..."
            if ! node scripts/validate-manifest.js "$manifest"; then
              VALIDATION_FAILED=1
            fi
            echo "---"
          done
          
          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo "❌ One or more manifests failed validation"
            exit 1
          else
            echo "✅ All manifests passed validation"
          fi